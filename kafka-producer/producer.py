from kafka import KafkaProducer
import csv
import json
from threading import Thread
import logging
import time



def kafka_python_producer_sync(producer, row, topic):
    test = {"tweet": row}
    # test = {"tweet": [{"user_name": "Zack Shephard", "user_location": "", "user_description": "My opinions are mine ALONE. Venting is the only way that I can get everthing off my chest. #BeKind #FoxNewsIsGoingToHell #BlackLivesMatter", "user_created": "2011-12-03 20:36:55", "user_followers": "89.0", "user_friends": "2598", "user_favourites": "212886", "user_verified": "False", "date": "2021-08-01 23:59:18", "text": "The next great #F1 duo!!! @ESPNF1 https://t.co/WMhaoAdSxF", "hashtags": "['F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Matteo Vannucci", "user_location": "", "user_description": "Free speech, free ideas, random thoughts", "user_created": "2010-05-28 01:02:32", "user_followers": "10.0", "user_friends": "40", "user_favourites": "8", "user_verified": "False", "date": "2021-08-01 23:59:10", "text": "@F1 What if\u2026Hamilton would have gone to the pit\u2026empty grid for a start?!\ud83e\udd14 something to think about #HungarianGP #F1", "hashtags": "['HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Michelle", "user_location": "The Burbs", "user_description": "likes- movies, candy, being lazy, formula 1,  65\u00b0F, watching various sports & reality shows\n\ndislikes- phone calls, bugs, hot weather, most foods, & group texts", "user_created": "2009-03-04 16:53:13", "user_followers": "231.0", "user_friends": "110", "user_favourites": "428", "user_verified": "False", "date": "2021-08-01 23:58:48", "text": "This has been a tiring #f1 day... https://t.co/34ggWgAlT6", "hashtags": "['f1']", "source": "Twitter for Android", "is_retweet": "False"}, {"user_name": "JoshWFC \ud83c\udde7\ud83c\uddf7", "user_location": "", "user_description": "| JP10\u2019s biggest fan | pronouns : Jo\u00e3o/Pedro | @watfordfc | @RamsNFL | @GeorgeRussell63", "user_created": "2021-04-05 16:14:53", "user_followers": "156.0", "user_friends": "443", "user_favourites": "2994", "user_verified": "False", "date": "2021-08-01 23:58:11", "text": "Valteri Bottass tracking down Max Verstappen on the way home\n\n#F1 https://t.co/epTHlDyjU6", "hashtags": "['F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Ria Tagulinao", "user_location": "MNL", "user_description": "Fun-sized Filipina writer @Medium", "user_created": "2009-06-22 16:08:51", "user_followers": "833.0", "user_friends": "379", "user_favourites": "30891", "user_verified": "False", "date": "2021-08-01 23:57:40", "text": "No words to describe the #HungarianGP so I will just say it was a fantastic shit race\n\nVettel deserved P2\nHam shunning all the haters w/ the 6pt lead\nALO-HAM battle on repeat\nCongrats Ocon\nI am still grieving for Lando\u2019s broken streak\n\n#F1", "hashtags": "['HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Abi", "user_location": "", "user_description": "\ud83c\udfce  \u267f\ufe0f", "user_created": "2015-06-26 20:52:32", "user_followers": "291.0", "user_friends": "686", "user_favourites": "76158", "user_verified": "False", "date": "2021-08-01 23:56:41", "text": "SEB SAID LGBTQ+ RIGHTS!! #F1 #LGBTQ https://t.co/25NqrgN3my", "hashtags": "['F1', 'LGBTQ']", "source": "Twitter for Android", "is_retweet": "False"}, {"user_name": "cat1128", "user_location": "", "user_description": "", "user_created": "2014-03-09 16:14:03", "user_followers": "22.0", "user_friends": "37", "user_favourites": "13", "user_verified": "False", "date": "2021-08-01 23:56:19", "text": "Do they remove Ocon too? Ham to be first.\nThis is the grand-prix for Mercedes to Mercedes by Mercedes.\n\n#SebastianVettel #EstebanOcon \n#f1 #HungarianGP #HungaryGP", "hashtags": "['SebastianVettel', 'EstebanOcon', 'f1', 'HungarianGP', 'HungaryGP']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "NMM", "user_location": "Canada", "user_description": "", "user_created": "2010-09-16 18:48:19", "user_followers": "58.0", "user_friends": "334", "user_favourites": "983", "user_verified": "False", "date": "2021-08-01 23:55:18", "text": "Breaking news FIA has disqualified  @OconEsteban for running down the pit lane too fast @LewisHamilton takes the win #F1 #HungaryGP #BREAKINGNEWS #FIA", "hashtags": "['F1', 'HungaryGP', 'BREAKINGNEWS', 'FIA']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Al Rowell", "user_location": "South Georgia, USA", "user_description": "Proud Georgia Democrat committed to public education & to ensuring the best lives for Georgia's children. Trekkie \ud83d\udd96", "user_created": "2008-12-23 22:29:13", "user_followers": "1416.0", "user_friends": "2035", "user_favourites": "15833", "user_verified": "False", "date": "2021-08-01 23:54:25", "text": "VIDEO\u2014\"They can disqualify me if they want\"-Sebastian Vettel, who wore a Same Love shirt for pre-race and rainbow mask for post-race interviews to defy anti-#LGBT edicts of Hungary PM Viktor Orb\u00e1n | #HungarianGP #F1 https://t.co/UU0PPCUT6K via @YouTube", "hashtags": "['LGBT', 'HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Downforce Radio \ud83e\udde1", "user_location": "UK", "user_description": "24/7 radio and videos from F1 to club racing, LIVE motorsports coverage, gaming on YouTube and Twitch, in partnership with @ClaphamMOT proud to support @Autism", "user_created": "2013-02-06 22:19:29", "user_followers": "3860.0", "user_friends": "2995", "user_favourites": "2295", "user_verified": "False", "date": "2021-08-01 23:54:08", "text": "#NowPlaying on https://t.co/5L1U2uVCQV Downforce Radio - Episode 6: Motoring Pride and Larking About \n\nThe Nation's Motorsport Station!! #radio\u00a0#motorsport #f1 #btcc #racing #music #cars https://t.co/PIjC5niHw3", "hashtags": "['NowPlaying', 'radio', 'motorsport', 'f1', 'btcc', 'racing', 'music', 'cars']", "source": "Radio King LiveTweet", "is_retweet": "False"}]}
    # test = {"tweet": [{"user_name": "Zack Shephard", "user_location": "", "user_description": "My opinions are mine ALONE. Venting is the only way that I can get everthing off my chest. #BeKind #FoxNewsIsGoingToHell #BlackLivesMatter", "user_created": "2011-12-03 20:36:55", "user_followers": "89.0", "user_friends": "2598", "user_favourites": "212886", "user_verified": "False", "date": "2021-08-01 23:59:18", "text": "The next great #F1 duo!!! @ESPNF1 https://t.co/WMhaoAdSxF", "hashtags": "['F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Matteo Vannucci", "user_location": "", "user_description": "Free speech, free ideas, random thoughts", "user_created": "2010-05-28 01:02:32", "user_followers": "10.0", "user_friends": "40", "user_favourites": "8", "user_verified": "False", "date": "2021-08-01 23:59:10", "text": "@F1 What if\u2026Hamilton would have gone to the pit\u2026empty grid for a start?!\ud83e\udd14 something to think about #HungarianGP #F1", "hashtags": "['HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Michelle", "user_location": "The Burbs", "user_description": "likes- movies, candy, being lazy, formula 1,  65\u00b0F, watching various sports & reality shows\n\ndislikes- phone calls, bugs, hot weather, most foods, & group texts", "user_created": "2009-03-04 16:53:13", "user_followers": "231.0", "user_friends": "110", "user_favourites": "428", "user_verified": "False", "date": "2021-08-01 23:58:48", "text": "This has been a tiring #f1 day... https://t.co/34ggWgAlT6", "hashtags": "['f1']", "source": "Twitter for Android", "is_retweet": "False"}, {"user_name": "JoshWFC \ud83c\udde7\ud83c\uddf7", "user_location": "", "user_description": "| JP10\u2019s biggest fan | pronouns : Jo\u00e3o/Pedro | @watfordfc | @RamsNFL | @GeorgeRussell63", "user_created": "2021-04-05 16:14:53", "user_followers": "156.0", "user_friends": "443", "user_favourites": "2994", "user_verified": "False", "date": "2021-08-01 23:58:11", "text": "Valteri Bottass tracking down Max Verstappen on the way home\n\n#F1 https://t.co/epTHlDyjU6", "hashtags": "['F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Ria Tagulinao", "user_location": "MNL", "user_description": "Fun-sized Filipina writer @Medium", "user_created": "2009-06-22 16:08:51", "user_followers": "833.0", "user_friends": "379", "user_favourites": "30891", "user_verified": "False", "date": "2021-08-01 23:57:40", "text": "No words to describe the #HungarianGP so I will just say it was a fantastic shit race\n\nVettel deserved P2\nHam shunning all the haters w/ the 6pt lead\nALO-HAM battle on repeat\nCongrats Ocon\nI am still grieving for Lando\u2019s broken streak\n\n#F1", "hashtags": "['HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Abi", "user_location": "", "user_description": "\ud83c\udfce  \u267f\ufe0f", "user_created": "2015-06-26 20:52:32", "user_followers": "291.0", "user_friends": "686", "user_favourites": "76158", "user_verified": "False", "date": "2021-08-01 23:56:41", "text": "SEB SAID LGBTQ+ RIGHTS!! #F1 #LGBTQ https://t.co/25NqrgN3my", "hashtags": "['F1', 'LGBTQ']", "source": "Twitter for Android", "is_retweet": "False"}, {"user_name": "cat1128", "user_location": "", "user_description": "", "user_created": "2014-03-09 16:14:03", "user_followers": "22.0", "user_friends": "37", "user_favourites": "13", "user_verified": "False", "date": "2021-08-01 23:56:19", "text": "Do they remove Ocon too? Ham to be first.\nThis is the grand-prix for Mercedes to Mercedes by Mercedes.\n\n#SebastianVettel #EstebanOcon \n#f1 #HungarianGP #HungaryGP", "hashtags": "['SebastianVettel', 'EstebanOcon', 'f1', 'HungarianGP', 'HungaryGP']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "NMM", "user_location": "Canada", "user_description": "", "user_created": "2010-09-16 18:48:19", "user_followers": "58.0", "user_friends": "334", "user_favourites": "983", "user_verified": "False", "date": "2021-08-01 23:55:18", "text": "Breaking news FIA has disqualified  @OconEsteban for running down the pit lane too fast @LewisHamilton takes the win #F1 #HungaryGP #BREAKINGNEWS #FIA", "hashtags": "['F1', 'HungaryGP', 'BREAKINGNEWS', 'FIA']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Al Rowell", "user_location": "South Georgia, USA", "user_description": "Proud Georgia Democrat committed to public education & to ensuring the best lives for Georgia's children. Trekkie \ud83d\udd96", "user_created": "2008-12-23 22:29:13", "user_followers": "1416.0", "user_friends": "2035", "user_favourites": "15833", "user_verified": "False", "date": "2021-08-01 23:54:25", "text": "VIDEO\u2014\"They can disqualify me if they want\"-Sebastian Vettel, who wore a Same Love shirt for pre-race and rainbow mask for post-race interviews to defy anti-#LGBT edicts of Hungary PM Viktor Orb\u00e1n | #HungarianGP #F1 https://t.co/UU0PPCUT6K via @YouTube", "hashtags": "['LGBT', 'HungarianGP', 'F1']", "source": "Twitter for iPhone", "is_retweet": "False"}, {"user_name": "Downforce Radio \ud83e\udde1", "user_location": "UK", "user_description": "24/7 radio and videos from F1 to club racing, LIVE motorsports coverage, gaming on YouTube and Twitch, in partnership with @ClaphamMOT proud to support @Autism", "user_created": "2013-02-06 22:19:29", "user_followers": "3860.0", "user_friends": "2995", "user_favourites": "2295", "user_verified": "False", "date": "2021-08-01 23:54:08", "text": "#NowPlaying on https://t.co/5L1U2uVCQV Downforce Radio - Episode 6: Motoring Pride and Larking About \n\nThe Nation's Motorsport Station!! #radio\u00a0#motorsport #f1 #btcc #racing #music #cars https://t.co/PIjC5niHw3", "hashtags": "['NowPlaying', 'radio', 'motorsport', 'f1', 'btcc', 'racing', 'music', 'cars']", "source": "Radio King LiveTweet", "is_retweet": "False"}]}
    producer.send(topic, value=test)
    producer.flush(timeout=60)


def success(metadata):
    print(metadata.topic)


def error(exception):
    print(exception)


def kafka_python_producer_async(producer, msg, topic):
    producer.send(topic, bytes(msg, encoding='utf-8')).add_callback(success).add_errback(error)
    producer.flush()

class F1Producer(Thread):

    def __init__(self):
        Thread.__init__(self)
        self.producer = KafkaProducer(bootstrap_servers='34.135.81.38:9092',
                                      value_serializer=lambda v: json.dumps(v).encode('utf-8')) 
                                                
    def run(self):
        try:
            with open('/Users/jonathan/Documents/JADS/year-1/data-engineering/DE-assignment-2/work_dir/data/stream/random.csv') as file:
                reader = csv.DictReader(file, delimiter=",")
                lines = [row for row in reader]
            
            batchsize = 1000

            for i in range(0, 10000, batchsize):
                batch = lines[i:i + batchsize]
                kafka_python_producer_sync(self.producer, batch, 'tweet')
                time.sleep(20)
            
            # kafka_python_producer_sync(self.producer, batch, 'tweet')
            
            # for i in range(0, len(lines), batchsize):
            #     batch = lines[i:i+batchsize]
            #     kafka_python_producer_sync(self.producer, batch, 'tweet')
            #     time.sleep(10)

            file.close()

        except Exception as err:
            print(err)
            logging.info(f"Unexpected {err=}, {type(err)=}")
            time.sleep(30)
        

if __name__ == '__main__':
    producer = F1Producer()
    producer.run()